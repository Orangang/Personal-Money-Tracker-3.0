<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dmitry — Personal Money Tracker</title>
<link rel="shortcut icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><text y='50%' x='50%' dominant-baseline='middle' text-anchor='middle' font-size='42'>₽</text></svg>">

<style>
/* ===== ШРИФТ ===== */
@font-face{
  font-family:"SF Pro Display";
  font-style:normal;
  font-weight:100 900;
  src:local("SF Pro Display"), local("SFProDisplay-Regular");
  font-display:swap;
}

/* ===== ТОКЕНЫ/БАЗА ===== */
:root{
  --bg:#fafafa; --card:#fff; --ink:#111; --muted:#666; --line:#eaeaea;
  --ok:#1f8b4c; --warn:#cc7a00; --bad:#c0392b; --accent:#2d6cdf;
  --radius:12px; --gap:16px; --shadow:0 2px 10px rgba(0,0,0,.06);
  --fs-base:clamp(14px,1.4vw,16px); --fs-sm:clamp(12px,1.2vw,14px); --fs-lg:clamp(16px,1.6vw,18px);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:var(--bg); color:var(--ink);
  font:400 var(--fs-base)/1.45 "SF Pro Display",-apple-system,system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif;
}
a{color:var(--accent); text-decoration:none}
.container{ max-width:1200px; margin:0 auto; padding:20px; }

h1{ font-size:clamp(20px,2.6vw,28px); margin:0 0 12px; font-weight:600 }
h2{ font-size:clamp(18px,2.2vw,22px); margin:0 0 12px; font-weight:600 }
h3{ font-size:clamp(16px,2vw,20px); margin:0 0 10px; font-weight:600 }
.muted{ color:var(--muted) }

/* ===== ГРИД-УТИЛИТЫ ===== */
.row{ display:grid; gap:var(--gap); }
.row.cols-2{ grid-template-columns:1fr; }
.row.cols-3{ grid-template-columns:1fr; grid-auto-rows:1fr; } /* одинаковая высота строк */
.row.cols-4{ grid-template-columns:1fr; }
@media (min-width:640px){
  .row.cols-2{ grid-template-columns:1fr 1fr; }
  .row.cols-3{ grid-template-columns:1fr 1fr; }      /* планшет = 2 колонки */
  .row.cols-4{ grid-template-columns:1fr 1fr 1fr 1fr; }
}
@media (min-width:960px){
  .row.cols-3{ grid-template-columns:1fr 1fr 1fr; }  /* десктоп = 3 колонки */
}

/* карточки внутри .cols-3 растягиваем на одинаковую высоту */
.row.cols-3 > .card{ height:100%; display:flex; flex-direction:column; }

/* ===== КАРТОЧКИ/БЭЙДЖИ ===== */
.card{
  background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
  box-shadow:var(--shadow); padding:16px;
}
.card + .card{ margin-top:16px; }
.card-title{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px; }
.badge{ font-size:var(--fs-sm); padding:2px 8px; border-radius:999px; background:#f2f6ff; border:1px solid #dbe7ff; color:#1f4fbf }

/* KPI — две колонки (одна на мобиле) */
.kpis{ display:grid; gap:12px; grid-template-columns:1fr 1fr; }
@media (max-width:639.98px){ .kpis{ grid-template-columns:1fr; } }
.kpi{ padding:12px; border:1px solid var(--line); border-radius:10px; }
.kpi b{ font-size:var(--fs-lg) }

/* Счета — 5 в ряд на десктопе */
.grid-accounts{ display:grid; gap:12px; grid-template-columns:1fr 1fr; }
@media (min-width:640px){ .grid-accounts{ grid-template-columns:repeat(5,1fr); } }
.account{ border:1px solid var(--line); border-radius:10px; padding:12px; }
.account h4{ margin:0 0 8px; font-size:var(--fs-lg) }
.account .sum{ font-weight:700 }
.account .hint{ font-size:var(--fs-sm); color:var(--muted) }

/* ===== ФОРМЫ/ОТСТУПЫ/ВЫСОТЫ ===== */
label{ font-size:var(--fs-sm); color:var(--muted); display:block; margin:0 0 12px; } /* даем отступ ПОСЛЕ поля */
label > :is(input,select,textarea){ margin-top:6px; }

input, select, textarea{
  width:100%; min-height:48px; padding:12px 14px;
  border:1px solid var(--line); border-radius:8px;
  background:#fff; color:#111; font:inherit;
}
/* Дата/месяц — как обычные поля */
input[type="date"], input[type="month"]{
  -webkit-appearance:none; appearance:none;
  width:100%; min-height:48px; line-height:1.2; padding:12px 14px;
}
input[type="date"]::-webkit-date-and-time-value,
input[type="month"]::-webkit-date-and-time-value{ text-align:left }

/* Select (Тип/Счёт/Откуда/Куда) — такая же высота */
select{ -webkit-appearance:none; appearance:none; min-height:48px; line-height:1.2; padding:12px 14px; }

.controls{ display:flex; flex-wrap:wrap; gap:8px; margin-top:auto; } /* в .cols-3 кнопки прижмутся вниз */

/* Кнопки */
button{
  height:44px; min-height:44px; padding:0 16px; line-height:1;
  border-radius:8px; border:1px solid #d4e1ff; background:#eaf1ff;
  color:#1f4fbf; font-weight:600; cursor:pointer;
  display:inline-flex; align-items:center; justify-content:center;
}
button.primary{ border-color:#2d6cdf; background:#2d6cdf; color:#fff }
button.danger{ border-color:#ffddd9; background:#ffeceb; color:#b22a1f }
button.ghost{ background:#fff; border-color:var(--line); color:#111 }

/* Кнопки в заголовке «Транзакции» — в ряд */
.card .card-title .controls{ display:flex; flex-wrap:nowrap; gap:8px; }
@media (max-width:640px){
  .card .card-title{ flex-direction:column; align-items:flex-start; gap:6px; }
  .card .card-title .controls{ width:100%; overflow:auto; }
  .card .card-title .controls button{ white-space:nowrap; flex:0 0 auto; }
  input, select, textarea{ font-size:16px; } /* анти-зум iOS */
}

hr{ border:none; border-top:1px solid var(--line); margin:12px 0 }
.table{ width:100%; border-collapse:collapse }
.table th,.table td{ border-bottom:1px solid var(--line); padding:8px; text-align:left; font-size:var(--fs-sm) }
.table th{ color:var(--muted); font-weight:600 }
.tag{ display:inline-block; padding:2px 8px; font-size:var(--fs-sm); border:1px solid var(--line); border-radius:999px }
.help{ font-size:var(--fs-sm); color:var(--muted) }
footer{ margin:24px 0; text-align:center; color:var(--muted); font-size:var(--fs-sm) }

/* ===== Прогресс долга ===== */
.progress{ height:10px; background:#f1f1f1; border-radius:999px; overflow:hidden; border:1px solid var(--line) }
.progress > i{ display:block; height:100%; background:linear-gradient(90deg,#6aa3ff,#2d6cdf) }

/* хедер справа */
.header-right{ display:flex; align-items:center; gap:8px; }
</style>
</head>

<body>
<div class="container">
  <header style="margin-bottom:16px">
    <h1>Личный финтрекер Дмитрия</h1>
    <div class="muted">4 счёта + долг • локально, без бэкенда • экспорт/импорт JSON</div>
  </header>

  <!-- ДАШБОРД -->
  <section class="card">
    <div class="card-title">
      <h2 style="margin:0">Дашборд</h2>
      <span class="badge" id="currentMonthBadge"></span>
    </div>

    <div class="kpis" style="margin-bottom:12px">
      <div class="kpi">
        <div class="muted">Доходы (месяц)</div>
        <b id="kpiIncomeMonth">—</b>
      </div>
      <div class="kpi">
        <div class="muted">Расходы (месяц)</div>
        <b id="kpiExpenseMonth">—</b>
      </div>
      <div class="kpi">
        <div class="muted">Траты сегодня</div>
        <b id="kpiToday">—</b>
      </div>
      <div class="kpi">
        <div class="muted">Баланс всех счетов</div>
        <b id="kpiTotal">—</b>
      </div>
    </div>

    <div class="grid-accounts" id="accountsGrid"></div>

    <div style="margin-top:12px">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:6px">
        <div class="muted">Прогресс погашения долга</div>
        <div class="muted" id="debtLabel">—</div>
      </div>
      <div class="progress"><i id="debtProgress" style="width:0%"></i></div>
    </div>
  </section>

  <!-- ОПЕРАЦИИ -->
  <section class="row cols-3" style="margin-top:16px">
    <!-- Доход -->
    <div class="card">
      <h3>Добавить доход</h3>
      <label>Дата <input type="date" id="incDate"></label>
      <label>Сумма ₽ <input type="number" id="incAmount" min="0" step="0.01" placeholder="Напр. 100000"></label>
      <label>Категория <input type="text" id="incCategory" placeholder="Зарплата / Фриланс"></label>
      <label>Заметка <input type="text" id="incNote" placeholder="Опционально"></label>
      <div class="help">Доход распределится по 4 счетам согласно долям в настройках.</div>
      <div class="controls">
        <button class="primary" id="btnAddIncome">Добавить</button>
        <button class="ghost" id="btnPreviewSplit">Посмотреть распределение</button>
      </div>
      <div id="splitPreview" class="help" style="display:none; margin-top:6px"></div>
    </div>

    <!-- Расход -->
    <div class="card">
      <h3>Добавить расход</h3>
      <label>Дата <input type="date" id="expDate"></label>
      <label>Сумма ₽ <input type="number" id="expAmount" min="0" step="0.01" placeholder="Напр. 2500"></label>
      <label>Счёт
        <select id="expAcc">
          <option value="base">Базовый</option>
          <option value="fixed">Расходный</option>
          <option value="fun">Весёлый</option>
          <option value="save">Накопления</option>
        </select>
      </label>
      <label>Категория <input type="text" id="expCategory" placeholder="Еда / Подписки / Транспорт"></label>
      <label>Заметка <input type="text" id="expNote" placeholder="Опционально"></label>
      <div class="controls">
        <button class="primary" id="btnAddExpense">Добавить</button>
      </div>
    </div>

    <!-- Перевод / Долг -->
    <div class="card">
      <h3>Переводы и долг</h3>
      <details class="modal" style="margin-bottom:8px" open>
        <summary class="summary-row">Перевод между счетами <small>внутренний</small></summary>
        <div class="row" style="margin-top:8px">
          <div>
            <label>Дата <input type="date" id="trDate"></label>
          </div>
          <div>
            <label>Сумма ₽ <input type="number" id="trAmount" min="0" step="0.01"></label>
          </div>
        </div>
        <div class="row cols-2">
          <label>Откуда
            <select id="trFrom">
              <option value="base">Базовый</option>
              <option value="fixed">Расходный</option>
              <option value="fun">Весёлый</option>
              <option value="save">Накопления</option>
            </select>
          </label>
          <label>Куда
            <select id="trTo">
              <option value="base">Базовый</option>
              <option value="fixed">Расходный</option>
              <option value="fun">Весёлый</option>
              <option value="save">Накопления</option>
            </select>
          </label>
        </div>
        <label>Заметка <input type="text" id="trNote" placeholder="Опционально"></label>
        <div class="controls">
          <button class="primary" id="btnTransfer">Перевести</button>
        </div>
      </details>

      <details class="modal">
        <summary class="summary-row">Платёж по долгу <small>фиксируется прогресс</small></summary>
        <div class="row" style="margin-top:8px">
          <div>
            <label>Дата <input type="date" id="debtDate"></label>
          </div>
          <div>
            <label>Сумма ₽ <input type="number" id="debtPayAmount" min="0" step="0.01"></label>
          </div>
        </div>
        <label>Списать с счёта (опционально)
          <select id="debtFrom">
            <option value="">— не списывать —</option>
            <option value="base">Базовый</option>
            <option value="fixed">Расходный</option>
            <option value="fun">Весёлый</option>
            <option value="save">Накопления</option>
          </select>
        </label>
        <label>Заметка <input type="text" id="debtNote" placeholder="Опционально"></label>
        <div class="controls">
          <button class="primary" id="btnDebtPay">Учесть платёж</button>
          <button class="ghost" id="btnDebtReset">Сбросить прогресс</button>
        </div>
      </details>
    </div>
  </section>

  <!-- ТРАНЗАКЦИИ -->
  <section class="card" style="margin-top:16px">
    <div class="card-title">
      <h2 style="margin:0">Транзакции</h2>
      <div class="controls">
        <button id="btnExport">Экспорт JSON</button>
        <label style="display:inline-flex; align-items:center; gap:8px">
          <input type="file" id="fileImport" accept="application/json" style="display:none">
          <button class="ghost" id="btnImport">Импорт JSON</button>
        </label>
        <button class="danger" id="btnWipe">Стереть всё</button>
      </div>
    </div>

    <div class="row cols-4" style="margin-bottom:8px">
      <label>Месяц
        <input type="month" id="fltMonth">
      </label>
      <label>Тип
        <select id="fltType">
          <option value="">Все</option>
          <option value="income">Доход</option>
          <option value="expense">Расход</option>
          <option value="transfer">Перевод</option>
          <option value="debt">Долг</option>
        </select>
      </label>
      <label>Счёт
        <select id="fltAcc">
          <option value="">Все</option>
          <option value="base">Базовый</option>
          <option value="fixed">Расходный</option>
          <option value="fun">Весёлый</option>
          <option value="save">Накопления</option>
        </select>
      </label>
      <label>Поиск
        <input type="text" id="fltSearch" placeholder="категория/заметка">
      </label>
    </div>

    <div class="row cols-2">
      <div class="help" id="listInfo">—</div>
      <div style="text-align:right" class="help"><span class="tag">сегодня: <b id="todayStr">—</b></span></div>
    </div>

    <div style="overflow:auto">
      <table class="table" id="txTable">
        <thead>
          <tr>
            <th>Дата</th>
            <th>Тип</th>
            <th>Счета</th>
            <th>Сумма</th>
            <th>Категория</th>
            <th>Заметка</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- НАСТРОЙКИ -->
  <section class="card" style="margin-top:16px">
    <h2>Настройки</h2>
    <div class="row cols-4">
      <label>Базовый ₽ <input type="number" id="stBase" min="0" step="0.01"></label>
      <label>Расходный ₽ <input type="number" id="stFixed" min="0" step="0.01"></label>
      <label>Весёлый ₽ <input type="number" id="stFun" min="0" step="0.01"></label>
      <label>Накопления ₽ <input type="number" id="stSave" min="0" step="0.01"></label>
    </div>
    <div class="row cols-4" style="margin-top:8px">
      <label>Сумма долга ₽ <input type="number" id="stDebtTotal" min="0" step="0.01"></label>
      <label>Уже погашено ₽ <input type="number" id="stDebtPaid" min="0" step="0.01"></label>
      <label>Начало месяца (день) <input type="number" id="stMonthStart" min="1" max="28"></label>
    </div>
    <h3 style="margin-top:12px">Доли авто-раскидки дохода (%)</h3>
    <div class="row cols-4">
      <label>Базовый % <input type="number" id="spBase" min="0" max="100"></label>
      <label>Расходный % <input type="number" id="spFixed" min="0" max="100"></label>
      <label>Весёлый % <input type="number" id="spFun" min="0" max="100"></label>
      <label>Накопления % <input type="number" id="spSave" min="0" max="100"></label>
    </div>
    <div class="help" id="splitSumHelp" style="margin-top:6px">Сумма долей должна быть 100%.</div>
    <div class="controls">
      <button class="primary" id="btnSaveSettings">Сохранить настройки</button>
      <button class="ghost" id="btnFillDemo">Загрузить демо-данные</button>
    </div>
  </section>

  <footer>v1 • локальное хранение • сделано под тебя</footer>
</div>

<script>
/* ============================================================================
   Personal Money Tracker — оффлайн, без бэкенда
   ============================================================================ */
(() => {
  "use strict";

  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const fmtRUB = (n) => (Number(n)||0).toLocaleString('ru-RU', {style:'currency', currency:'RUB', maximumFractionDigits:0});
  const fmtNum = (n, d=0) => (Number(n)||0).toLocaleString('ru-RU', {minimumFractionDigits:d, maximumFractionDigits:d});
  const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
  const todayISO = () => new Date().toISOString().slice(0,10);
  const monthStr = (d=new Date()) => d.toLocaleString('ru-RU', {month:'long', year:'numeric'});
  const uid = () => Math.random().toString(36).slice(2,10) + Date.now().toString(36).slice(-4);

  const LS_KEY = 'dm_fin_v1';
  let state = load();

  function load(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(raw) return JSON.parse(raw);
    }catch(e){}
    return {
      settings:{
        accounts:{ base:0, fixed:0, fun:0, save:0, debtTotal:0, debtPaid:0 },
        autosplit:{ base:40, fixed:30, fun:10, save:20 },
        monthStartDay:1
      },
      transactions:[]
    };
  }
  function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

  // Инициализация дат/месяца
  $('#incDate').value = todayISO();
  $('#expDate').value = todayISO();
  $('#trDate').value = todayISO();
  $('#debtDate').value = todayISO();
  $('#fltMonth').value = new Date().toISOString().slice(0,7);

  // Настройки -> UI
  function fillSettingsUI(){
    const A = state.settings.accounts;
    $('#stBase').value = A.base;
    $('#stFixed').value = A.fixed;
    $('#stFun').value = A.fun;
    $('#stSave').value = A.save;
    $('#stDebtTotal').value = A.debtTotal;
    $('#stDebtPaid').value = A.debtPaid;
    $('#stMonthStart').value = state.settings.monthStartDay;

    const S = state.settings.autosplit;
    $('#spBase').value = S.base;
    $('#spFixed').value = S.fixed;
    $('#spFun').value   = S.fun;
    $('#spSave').value  = S.save;
    updateSplitSumHelp();
  }
  function updateSplitSumHelp(){
    const sum = ['base','fixed','fun','save'].reduce((s,k)=>s+Number($('#sp'+k[0].toUpperCase()+k.slice(1)).value||0),0);
    $('#splitSumHelp').textContent = `Сумма долей: ${sum}% (должно быть 100%).`;
    $('#splitSumHelp').style.color = (sum===100)? 'var(--muted)' : 'var(--bad)';
  }
  ['spBase','spFixed','spFun','spSave'].forEach(id => $('#'+id).addEventListener('input', updateSplitSumHelp));

  // Дашборд
  function renderDashboard(){
    $('#currentMonthBadge').textContent = monthStr(new Date()));

    const A = state.settings.accounts;
    const accs = [
      {key:'base', title:'Базовый', hint:'зарплата'},
      {key:'fixed',title:'Расходный', hint:'фикс. платежи'},
      {key:'fun',  title:'Весёлый',  hint:'удовольствия'},
      {key:'save', title:'Накопления',hint:'цели/подушка'},
      {key:'debt', title:'Долг', hint:'остаётся'}
    ];
    const grid = $('#accountsGrid');
    grid.innerHTML = '';
    accs.forEach(a => {
      const val = (a.key==='debt') ? Math.max(A.debtTotal - A.debtPaid, 0) : A[a.key];
      const div = document.createElement('div');
      div.className = 'account';
      div.innerHTML = `
        <h4>${a.title}</h4>
        <div class="sum">${fmtRUB(val)}</div>
        <div class="hint">${a.hint}</div>`;
      grid.appendChild(div);
    });

    const pct = (A.debtTotal>0) ? clamp((A.debtPaid/A.debtTotal)*100,0,100) : 0;
    $('#debtProgress').style.width = pct.toFixed(1)+'%';
    $('#debtLabel').textContent = `${fmtRUB(A.debtPaid)} из ${fmtRUB(A.debtTotal)} (${pct.toFixed(1)}%)`;

    const month = $('#fltMonth').value || new Date().toISOString().slice(0,7);
    const listM = state.transactions.filter(t => (t.date||'').startsWith(month));
    const sumIncome = listM.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
    const sumExpense = listM.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
    $('#kpiIncomeMonth').textContent = fmtRUB(sumIncome);
    $('#kpiExpenseMonth').textContent = fmtRUB(sumExpense);

    const tISO = todayISO();
    const todayExp = state.transactions.filter(t=>t.type==='expense' && t.date===tISO).reduce((s,t)=>s+t.amount,0);
    $('#kpiToday').textContent = fmtRUB(todayExp);

    const totalBal = A.base + A.fixed + A.fun + A.save;
    $('#kpiTotal').textContent = fmtRUB(totalBal);

    $('#todayStr').textContent = new Date().toLocaleDateString('ru-RU');
  }

  // Таблица
  function renderTable(){
    const month = $('#fltMonth').value || new Date().toISOString().slice(0,7);
    const tp = $('#fltType').value;
    const acc = $('#fltAcc').value;
    const q = ($('#fltSearch').value||'').trim().toLowerCase();

    let list = state.transactions.slice().sort((a,b)=> (a.date>b.date? -1: a.date<b.date? 1: 0));
    list = list.filter(t => (t.date||'').startsWith(month));
    if(tp) list = list.filter(t => t.type===tp);
    if(acc){
      list = list.filter(t => t.account===acc || t.fromAccount===acc || t.toAccount===acc);
    }
    if(q){
      list = list.filter(t => ((t.category||'')+(t.note||'')).toLowerCase().includes(q));
    }

    const tbody = $('#txTable tbody');
    tbody.innerHTML = '';
    for(const t of list){
      const tr = document.createElement('tr');
      const accounts = (
        t.type==='transfer' ? `${labelAcc(t.fromAccount)} → ${labelAcc(t.toAccount)}` :
        t.type==='income'   ? `${labelAcc(t.account)} (+)` :
        t.type==='expense'  ? `${labelAcc(t.account)} (−)` :
        t.type==='debt'     ? `Долг${t.account? ' (− '+labelAcc(t.account)+')':''}` : ''
      );
      tr.innerHTML = `
        <td>${t.date}</td>
        <td><span class="tag">${labelType(t.type)}</span></td>
        <td>${accounts||'—'}</td>
        <td style="white-space:nowrap">${(t.type==='expense'||(t.type==='transfer'&&t.fromAccount))?'-':''}${fmtNum(t.amount,0)} ₽</td>
        <td>${t.category||'—'}</td>
        <td>${t.note||''}</td>
        <td style="text-align:right"><button class="ghost" data-del="${t.id}">✕</button></td>`;
      tbody.appendChild(tr);
    }

    $('#listInfo').textContent = `Показано: ${list.length} операций. Всего в базе: ${state.transactions.length}.`;
    $$('button[data-del]').forEach(btn=>{
      btn.onclick = () => {
        const id = btn.getAttribute('data-del');
        state.transactions = state.transactions.filter(t=>t.id!==id);
        save(); renderAll();
      };
    });
  }
  function labelAcc(k){ return ({base:'Базовый', fixed:'Расходный', fun:'Весёлый', save:'Накопления'})[k] || '—'; }
  function labelType(t){ return ({income:'Доход', expense:'Расход', transfer:'Перевод', debt:'Долг'})[t] || t; }

  // Доход
  function incomeSplit(amount){
    const s = state.settings.autosplit;
    const round = (n)=>Math.round(Number(n)||0);
    const parts = {
      base: round(amount * (s.base/100)),
      fixed: round(amount * (s.fixed/100)),
      fun:   round(amount * (s.fun/100)),
      save:  round(amount * (s.save/100)),
    };
    const sum = parts.base + parts.fixed + parts.fun + parts.save;
    const delta = round(amount - sum);
    if(delta!==0) parts.base += delta;
    return parts;
  }
  $('#btnPreviewSplit').onclick = () => {
    const amount = Number($('#incAmount').value||0);
    if(!amount){ $('#splitPreview').style.display='none'; return; }
    const p = incomeSplit(amount);
    $('#splitPreview').style.display = 'block';
    $('#splitPreview').textContent =
      `Распределение: Базовый ${fmtRUB(p.base)}, Расходный ${fmtRUB(p.fixed)}, Весёлый ${fmtRUB(p.fun)}, Накопления ${fmtRUB(p.save)}.`;
  };
  $('#btnAddIncome').onclick = () => {
    const date = $('#incDate').value || todayISO();
    const amount = Number($('#incAmount').value||0);
    const category = ($('#incCategory').value||'Доход');
    const note = ($('#incNote').value||'');
    if(amount<=0) return alert('Введите сумму дохода > 0');

    const split = incomeSplit(amount);
    const A = state.settings.accounts;
    for(const k of ['base','fixed','fun','save']){
      if(split[k]>0){
        state.transactions.push({ id:uid(), date, type:'income', account:k, amount: split[k], category, note });
        A[k] += split[k];
      }
    }
    save();
    $('#incAmount').value=''; $('#incNote').value=''; $('#splitPreview').style.display='none';
    renderAll();
  };

  // Расход
  $('#btnAddExpense').onclick = () => {
    const date = $('#expDate').value || todayISO();
    const amount = Number($('#expAmount').value||0);
    const account = $('#expAcc').value;
    const category = ($('#expCategory').value||'Расход');
    const note = ($('#expNote').value||'');
    if(amount<=0) return alert('Введите сумму расхода > 0');
    const A = state.settings.accounts;
    if(A[account] < amount && !confirm('На счёте не хватает средств. Продолжить?')) return;

    state.transactions.push({ id:uid(), date, type:'expense', account, amount, category, note });
    A[account] -= amount;
    save();
    $('#expAmount').value=''; $('#expNote').value='';
    renderAll();
  };

  // Перевод
  $('#btnTransfer').onclick = () => {
    const date = $('#trDate').value || todayISO();
    const amount = Number($('#trAmount').value||0);
    const from = $('#trFrom').value;
    const to = $('#trTo').value;
    const note = ($('#trNote').value||'');
    if(amount<=0) return alert('Введите сумму перевода > 0');
    if(from===to) return alert('Выберите разные счета');
    const A = state.settings.accounts;
    if(A[from] < amount && !confirm('На счёте-источнике не хватает средств. Продолжить?')) return;

    state.transactions.push({ id:uid(), date, type:'transfer', fromAccount:from, toAccount:to, amount, category:'Перевод', note });
    A[from] -= amount; A[to] += amount;
    save();
    $('#trAmount').value=''; $('#trNote').value='';
    renderAll();
  };

  // Платёж по долгу
  $('#btnDebtPay').onclick = () => {
    const date = $('#debtDate').value || todayISO();
    const amount = Number($('#debtPayAmount').value||0);
    const from = $('#debtFrom').value;
    const note = ($('#debtNote').value||'');
    if(amount<=0) return alert('Введите сумму платежа > 0');

    state.transactions.push({ id:uid(), date, type:'debt', amount, account: from || undefined, category:'Платёж по долгу', note });

    if(from){
      const A = state.settings.accounts;
      if(A[from] < amount && !confirm('На счёте не хватает средств. Продолжить?')) return;
      A[from] -= amount;
    }
    const A = state.settings.accounts;
    A.debtPaid = clamp(Math.round(A.debtPaid + amount), 0, Math.round(A.debtTotal));
    save();
    $('#debtPayAmount').value=''; $('#debtNote').value='';
    renderAll();
  };
  $('#btnDebtReset').onclick = () => {
    if(confirm('Сбросить прогресс погашения долга?')){
      state.settings.accounts.debtPaid = 0;
      save(); renderAll();
    }
  };

  // Фильтры
  $('#fltMonth').oninput = ()=>{ renderDashboard(); renderTable(); };
  $('#fltType').oninput = renderTable;
  $('#fltAcc').oninput  = renderTable;
  $('#fltSearch').oninput = renderTable;

  // Настройки
  $('#btnSaveSettings').onclick = () => {
    const A = state.settings.accounts;
    A.base = Number($('#stBase').value||0);
    A.fixed = Number($('#stFixed').value||0);
    A.fun = Number($('#stFun').value||0);
    A.save = Number($('#stSave').value||0);
    A.debtTotal = Number($('#stDebtTotal').value||0);
    A.debtPaid  = Number($('#stDebtPaid').value||0);

    state.settings.autosplit = {
      base: Number($('#spBase').value||0),
      fixed: Number($('#spFixed').value||0),
      fun:   Number($('#spFun').value||0),
      save:  Number($('#spSave').value||0)
    };
    state.settings.monthStartDay = clamp(Number($('#stMonthStart').value||1),1,28);

    const sum = Object.values(state.settings.autosplit).reduce((s,n)=>s+Number(n||0),0);
    if(sum!==100){ return alert('Сумма долей должна быть 100%.'); }

    save(); renderAll();
    alert('Настройки сохранены.');
  };

  // Демо
  $('#btnFillDemo').onclick = () => {
    if(!confirm('Загрузить демо-данные и перезаписать текущие?')) return;
    const d = (shift)=>{ const z=new Date(); z.setDate(z.getDate()+shift); return z.toISOString().slice(0,10); };
    state = {
      settings:{
        accounts:{ base:35000, fixed:20000, fun:7000, save:45000, debtTotal:300000, debtPaid:65000 },
        autosplit:{ base:40, fixed:30, fun:10, save:20 }, monthStartDay:1
      },
      transactions:[
        {id:uid(), date:d(-25), type:'income', account:'base', amount:60000, category:'Зарплата', note:'автосплит'},
        {id:uid(), date:d(-25), type:'income', account:'fixed', amount:45000, category:'Зарплата', note:'автосплит'},
        {id:uid(), date:d(-25), type:'income', account:'fun', amount:15000, category:'Зарплата', note:'автосплит'},
        {id:uid(), date:d(-25), type:'income', account:'save', amount:30000, category:'Зарплата', note:'автосплит'},
        {id:uid(), date:d(-7), type:'expense', account:'fixed', amount:12000, category:'Аренда', note:''},
        {id:uid(), date:d(-6), type:'expense', account:'fixed', amount:1500, category:'Связь', note:''},
        {id:uid(), date:d(-5), type:'expense', account:'base', amount:2200, category:'Еда', note:'супермаркет'},
        {id:uid(), date:d(-4), type:'transfer', fromAccount:'base', toAccount:'save', amount:5000, category:'Перевод', note:'на подушку'},
        {id:uid(), date:d(-3), type:'expense', account:'fun', amount:3000, category:'Развлечения', note:'кино/бар'},
        {id:uid(), date:d(-2), type:'debt', amount:15000, account:'base', category:'Платёж по долгу', note:'погашение'},
      ]
    };
    save(); renderAll();
  };

  // Экспорт/Импорт/Wipe
  $('#btnExport').onclick = () => {
    const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `dm_fin_${new Дате().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  };
  $('#btnImport').onclick = () => { $('#fileImport').click(); };
  $('#fileImport').onchange = async (e) => {
    const file = e.target.files[0]; if(!file) return;
    try{
      const text = await file.text();
      const data = JSON.parse(text);
      if(!data.settings || !data.transactions) throw new Error('Неверный формат файла');
      state = data; save(); renderAll(); alert('Импорт выполнен.');
    }catch(err){ alert('Ошибка импорта: ' + err.message); }
    finally{ e.target.value = ''; }
  };
  $('#btnWipe').onclick = () => {
    if(confirm('Удалить все данные? Это действие необратимо.')){
      localStorage.removeItem(LS_KEY);
      state = load();
      renderAll();
    }
  };

  function renderAll(){ fillSettingsUI(); renderDashboard(); renderTable(); }
  renderAll();
})();
</script>
</body>
</html>
